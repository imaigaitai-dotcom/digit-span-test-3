<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Backward Digit Span Test</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { 
    font-family: system-ui, -apple-system, sans-serif; 
    text-align:center; 
    padding: 20px; 
    background-color:#f4f4f4; 
    color:#333;
    max-width: 650px;
    margin: 0 auto;
  }
  h1 { margin-bottom:8px; font-size:24px; color:#222; }
  
  /* è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #display { 
    font-size:72px; 
    height:140px; 
    margin:24px 0; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    background-color:#fff; 
    border-radius:12px; 
    box-shadow:0 4px 10px rgba(0,0,0,0.1); 
    transition: background-color 0.3s;
    font-weight: bold;
    color: #333;
  }
  
  /* å¾…æ©Ÿä¸­ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
  .display-idle { color: #ccc !important; letter-spacing: 4px; }

  /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ã®ã‚¯ãƒ©ã‚¹ */
  .correct-bg { background-color: #e8f5e9 !important; color: #2e7d32 !important; }
  .wrong-bg { background-color: #ffebee !important; color: #c62828 !important; }

  #controls { margin-top:16px; }
  
  input[type="text"]{ 
    font-size:24px; 
    padding:12px; 
    width:80%; 
    max-width: 280px; 
    text-align:center; 
    border-radius:8px; 
    border:2px solid #ccc; 
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="text"]:focus { border-color: #2196F3; }
  /* å…¥åŠ›ãŒå®Œäº†ã—ãŸï¼ˆæ¡æ•°ãŒè¶³ã‚Šã¦ã„ã‚‹ï¼‰æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  input[type="text"].ready { border-color: #4CAF50; background-color: #f1f8e9; }

  button { 
    font-size:18px; 
    padding:12px 24px; 
    margin:10px; 
    border:none; 
    border-radius:8px; 
    background-color:#4CAF50; 
    color:#fff; 
    cursor:pointer; 
    transition: all 0.2s; 
    font-weight: bold;
  }
  button:hover { opacity: 0.9; transform: translateY(-1px); }
  
  /* ç„¡åŠ¹åŒ–ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
  button:disabled { 
    background-color: #e0e0e0; 
    color: #a0a0a0; 
    cursor: not-allowed; 
    transform: none; 
    box-shadow: none;
  }

  #message { margin-top:14px; min-height:1.5em; font-size:16px; font-weight: bold; }
  
  .instructions { 
    font-size: 14px; 
    color: #555; 
    line-height: 1.6; 
    margin-bottom: 20px;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    text-align: left;
  }

  /* éŸ³æºé¸æŠã‚¨ãƒªã‚¢ */
  #audio-select {
    margin: 20px 0;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #fff;
    text-align: left;
  }
  #audio-select label { margin-right: 15px; font-weight: normal; cursor: pointer; }
  #audio-select input { cursor: pointer; }

  /* çµæœãƒ†ãƒ¼ãƒ–ãƒ« */
  table { margin:20px auto; border-collapse:collapse; width: 100%; background-color:#fff; border-radius:8px; overflow: hidden; }
  th, td { border:1px solid #ddd; padding:12px; text-align: center; }
  th { background-color:#f0f0f0; }

  #restartBtn { background-color:#2196F3; display: none; }
  #results { display: none; }
</style>
</head>
<body>

  <h1>Backward Digit Span Test</h1>
  
  <div class="instructions">
    <strong>ãƒ«ãƒ¼ãƒ«:</strong><br>
    è¡¨ç¤ºã•ã‚ŒãŸæ•°å­—ã‚’<strong>ã€Œé€†é †ã€</strong>ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹: è¡¨ç¤ºã€Œ1 5 9ã€ â†’ å…¥åŠ›ã€Œ9 5 1ã€ï¼‰<br>
    â€»æ•°å­—ã‚’ã™ã¹ã¦å…¥åŠ›ã™ã‚‹ã¾ã§é€ä¿¡ã§ãã¾ã›ã‚“ã€‚<br>
    â€»**2å›é€£ç¶šã§å¤±æ•—**ã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆçµ‚äº†ã§ã™ã€‚
  </div>
  
  <div id="audio-select">
    <strong>ğŸ§ ãƒ†ã‚¹ãƒˆä¸­ã®éŸ³æºã‚’é¸æŠ:</strong><br>
    <div style="margin-top:8px;">
      <input type="radio" id="audio-none" name="audio" value="ç„¡éŸ³" checked>
      <label for="audio-none">ç„¡éŸ³</label>

      <input type="radio" id="audio-music" name="audio" value="éŸ³æ¥½">
      <label for="audio-music">éŸ³æ¥½ (music.mp3)</label>
      
      <input type="radio" id="audio-nature" name="audio" value="è‡ªç„¶ã®éŸ³">
      <label for="audio-nature">è‡ªç„¶ã®éŸ³ (nature.mp3)</label>
    </div>
  </div>

  <div id="display" class="display-idle" aria-live="polite">---</div>

  <div id="controls">
    <div id="message">éŸ³æºã‚’é¸æŠã—ã€ã€Œãƒ†ã‚¹ãƒˆé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    
    <input id="answer" type="text" inputmode="numeric" pattern="\d*" placeholder="é€†é †ã§å…¥åŠ›" disabled autocomplete="off" />
    
    <div>
      <button id="startBtn">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
      <button id="submitBtn" style="display:none;" disabled>å›ç­”ã™ã‚‹</button>
    </div>
  </div>

  <div id="results">
    <h3>ãƒ†ã‚¹ãƒˆçµæœ</h3>
    <table id="roundTable">
      <thead><tr><th>ãƒ¬ãƒ™ãƒ«ï¼ˆæ¡æ•°ï¼‰</th><th>çµæœ</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="audio-setting-result" style="margin-top: 15px; font-weight: bold; color:#555;"></div>
    <button id="restartBtn">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
  </div>

<script>
(() => {
  // è¨­å®š
  let currentLength = 4;  
  const startLength = 4;
  const showMs = 1000;    
  const interMs = 200;    
  const maxAttemptsPerRound = 2; 
  const nextLevelPause = 1000;
  const preShowPause = 1500;
  // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‹ã‚‰å•é¡ŒãŒå§‹ã¾ã‚‹ã¾ã§ã®å¾…æ©Ÿæ™‚é–“(ms)
  const initialAudioWait = 180000; 

  // çŠ¶æ…‹ç®¡ç†
  let attemptInLevel = 0; 
  let roundRecords = [];  
  let sequence = [];
  let selectedAudio = 'ç„¡éŸ³'; 
  let isDisplaying = false;
  let isWaitingInput = false;

  // éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
  const audioObjMusic = new Audio('music.mp3');
  const audioObjNature = new Audio('nature.mp3');
  
  // éŸ³é‡è¨­å®š
  audioObjMusic.volume = 0.2;  // â˜…å¤‰æ›´ç‚¹: éŸ³æ¥½ã®éŸ³é‡ã‚’ã•ã‚‰ã«ä¸‹ã’ã‚‹
  audioObjNature.volume = 1.0; // è‡ªç„¶ã®éŸ³ã¯æœ€å¤§ (1.0)

  audioObjMusic.loop = true;
  audioObjNature.loop = true;

  // DOMè¦ç´ 
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const submitBtn = document.getElementById('submitBtn');
  const display = document.getElementById('display');
  const answerInput = document.getElementById('answer');
  const message = document.getElementById('message');
  const resultsDiv = document.getElementById('results');
  const tbody = document.querySelector('#roundTable tbody');
  const audioSelectDiv = document.getElementById('audio-select');
  const audioSettingResultDiv = document.getElementById('audio-setting-result');

  // -----------------------------------------
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // -----------------------------------------
  function generateSequence(len){
    return Array.from({length: len}, () => String(Math.floor(Math.random()*10)));
  }

  function setVisualFeedback(type) {
    display.classList.remove('correct-bg', 'wrong-bg', 'display-idle');
    if(type === 'correct') {
      display.classList.add('correct-bg');
      display.textContent = 'â—‹';
    } else if (type === 'wrong') {
      display.classList.add('wrong-bg');
      display.textContent = 'Ã—';
    } else if (type === 'reset') {
       // ãƒªã‚»ãƒƒãƒˆ
    } else if (type === 'idle') {
      display.classList.add('display-idle');
      display.textContent = '---';
    }
  }

  // éŸ³å£°å†ç”Ÿåˆ¶å¾¡
  function playSelectedAudio() {
    stopAllAudio(); 
    selectedAudio = document.querySelector('input[name="audio"]:checked').value;

    if(selectedAudio === 'éŸ³æ¥½') {
      audioObjMusic.play().catch(e => {
        console.log(e);
        alert("ã€Œmusic.mp3ã€ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹å†ç”Ÿã§ãã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    } else if(selectedAudio === 'è‡ªç„¶ã®éŸ³') {
      audioObjNature.play().catch(e => {
        console.log(e);
        alert("ã€Œnature.mp3ã€ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹å†ç”Ÿã§ãã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      });
    }
    // ç„¡éŸ³ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
  }

  function stopAllAudio() {
    audioObjMusic.pause();
    audioObjNature.pause();
    audioObjMusic.currentTime = 0;
    audioObjNature.currentTime = 0;
  }

  // -----------------------------------------
  // ã‚²ãƒ¼ãƒ é€²è¡Œ
  // -----------------------------------------
  
  function startTest(){
    currentLength = startLength;
    roundRecords = [];
    
    startBtn.style.display = "none";
    audioSelectDiv.style.display = "none";
    resultsDiv.style.display = 'none';
    tbody.innerHTML = '';

    // éŸ³æºå†ç”Ÿé–‹å§‹
    playSelectedAudio();
    
    // éŸ³ã ã‘æµã—ã¦5ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ¬ãƒ™ãƒ«é–‹å§‹
    setTimeout(() => {
      startLevel();
    }, initialAudioWait);
  }

  function startLevel(){
    roundRecords.push({ level: currentLength, attempts: 0, failedOnce: false, pass: false });
    attemptInLevel = 1; 
    runTrial();
  }

  function runTrial(){
    isDisplaying = true;
    isWaitingInput = false;
    
    setVisualFeedback('reset');
    display.textContent = '';
    
    answerInput.value = '';
    answerInput.disabled = true;
    answerInput.classList.remove('ready'); 
    answerInput.placeholder = "æ•°å­—ã‚’è¨˜æ†¶ã—ã¦ãã ã•ã„...";
    
    submitBtn.style.display = 'none';
    submitBtn.disabled = true; 

    message.textContent = `${currentLength} æ¡ã®æ•°å­—ã‚’è¡¨ç¤ºã—ã¾ã™`;

    sequence = generateSequence(currentLength);

    setTimeout(() => {
      let i = 0;
      function showStep(){
        if(i < sequence.length){
          display.textContent = sequence[i];
          setTimeout(()=>{
            display.textContent = ''; 
            i++;
            setTimeout(showStep, interMs); 
          }, showMs);
        } else {
          isDisplaying = false;
          enableInput();
        }
      }
      showStep();
    }, preShowPause);
  }

  function enableInput(){
    isWaitingInput = true;
    display.textContent = 'ï¼Ÿ';
    answerInput.disabled = false;
    
    answerInput.maxLength = currentLength; 
    answerInput.placeholder = "é€†é †ã«å…¥åŠ›";
    answerInput.focus();
    
    message.textContent = "å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    
    submitBtn.style.display = 'inline-block';
  }

  function validateInput() {
    const isFull = answerInput.value.length === currentLength;
    submitBtn.disabled = !isFull;
    
    if(isFull) {
      answerInput.classList.add('ready');
      message.textContent = "Enter ã¾ãŸã¯ã€Œå›ç­”ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";
    } else {
      answerInput.classList.remove('ready');
      if(isWaitingInput) {
        message.textContent = "å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
      }
    }
    return isFull;
  }

  function checkAnswer(){
    if(!isWaitingInput) return;

    if(answerInput.value.length !== currentLength) {
      return; 
    }

    let userVal = answerInput.value.trim();
    userVal = userVal.replace(/[^0-9]/g, '');

    const correctVal = sequence.slice().reverse().join('');
    const isCorrect = (userVal === correctVal);

    isWaitingInput = false;
    answerInput.disabled = true;
    submitBtn.style.display = 'none';

    const currentRecord = roundRecords[roundRecords.length - 1];
    currentRecord.attempts++;

    if(isCorrect){
      message.textContent = "æ­£è§£ã§ã™ï¼";
      setVisualFeedback('correct');
      currentRecord.pass = true;
      setTimeout(nextLevel, nextLevelPause);
    } else {
      message.textContent = `ä¸æ­£è§£... (æ­£è§£: ${correctVal})`;
      setVisualFeedback('wrong');

      if(attemptInLevel === 1) {
          currentRecord.failedOnce = true;
          attemptInLevel++;
          setTimeout(runTrial, 2000);
      } else {
        setTimeout(endTest, 2000);
      }
    }
  }

  function nextLevel(){
    currentLength++;
    startLevel();
  }

  function endTest(){
    stopAllAudio(); 

    setVisualFeedback('reset'); 
    display.textContent = "çµ‚äº†";
    
    message.textContent = "ãƒ†ã‚¹ãƒˆçµ‚äº†ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚";
    showResults();
    
    restartBtn.style.display = 'inline-block';
  }

  function showResults(){
    resultsDiv.style.display = 'block';
    tbody.innerHTML = '';
    
    audioSettingResultDiv.textContent = `éŸ³æº: ${selectedAudio}`;
    
    const passedLevels = roundRecords.filter(r => r.pass).map(r => r.level);
    const maxLevel = passedLevels.length > 0 ? Math.max(...passedLevels) : 0;

    roundRecords.forEach(r => {
      const tr = document.createElement('tr');
      let resultText = '';
      
      if(r.pass) {
          if(r.failedOnce) {
              resultText = '<span style="color:orange;font-weight:bold;">ã‚¯ãƒªã‚¢ (2å›ç›®)</span>';
          } else {
              resultText = '<span style="color:green;font-weight:bold;">ã‚¯ãƒªã‚¢ (1å›ç›®)</span>';
          }
      } else {
          resultText = '<span style="color:#aaa;">å¤±æ•—</span>';
      }
      
      tr.innerHTML = `<td>${r.level} æ¡</td><td>${resultText}</td>`;
      tbody.appendChild(tr);
    });

    const scoreDiv = document.createElement('div');
    scoreDiv.innerHTML = `<h2 style="color:#2196F3; font-size: 28px;">è¨˜éŒ²: ${maxLevel} æ¡</h2>`;
    tbody.parentElement.before(scoreDiv);
  }

  // -----------------------------------------
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  // -----------------------------------------
  startBtn.addEventListener('click', startTest);
  
  restartBtn.addEventListener('click', () => {
    stopAllAudio(); 
    restartBtn.style.display = 'none';
    const scoreHeaders = resultsDiv.querySelectorAll('h2');
    scoreHeaders.forEach(el => el.remove());
    
    // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
    audioSelectDiv.style.display = "block";
    setVisualFeedback('idle'); 
    startBtn.style.display = "inline-block";
    message.textContent = "éŸ³æºã‚’é¸æŠã—ã€ã€Œãƒ†ã‚¹ãƒˆé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";
    resultsDiv.style.display = 'none';
    answerInput.value = '';
    answerInput.classList.remove('ready');
  });

  submitBtn.addEventListener('click', checkAnswer);

  answerInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      if(!submitBtn.disabled) {
        checkAnswer();
      }
    }
  });

  answerInput.addEventListener('input', () => {
    answerInput.value = answerInput.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    answerInput.value = answerInput.value.replace(/[^0-9]/g, '');

    if(answerInput.value.length > currentLength){
      answerInput.value = answerInput.value.slice(0, currentLength);
    }
    
    validateInput();
  });

})();
</script>
</body>

</html>
